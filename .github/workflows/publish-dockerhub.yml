name: Build and Publish Docker Images

on:
  push:
    branches:
      - main
      - master
    tags:
      - 'v*'
  workflow_dispatch:

env:
  REGISTRY_GHCR: ghcr.io
  REGISTRY_DOCKERHUB: docker.io

jobs:
  # Job 1: Build and push to Docker Hub (optional, requires secrets)
  build-and-push-dockerhub:
    name: Build and Push to Docker Hub
    runs-on: ubuntu-latest
    # Note: Secrets are checked at step level, not job level
    # The job will run but the login step will fail if secrets are missing
    
    strategy:
      matrix:
        variant: [cpu]  # Add 'gpu' if you want to build GPU images in CI
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Check Docker Hub credentials
        id: check_secrets
        run: |
          if [ -z "${{ secrets.DOCKERHUB_USERNAME }}" ] || [ -z "${{ secrets.DOCKERHUB_TOKEN }}" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "⚠️ Docker Hub credentials not configured. Skipping Docker Hub push."
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "✅ Docker Hub credentials found."
          fi
      
      - name: Set up Docker Buildx
        if: steps.check_secrets.outputs.skip == 'false'
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to Docker Hub
        if: steps.check_secrets.outputs.skip == 'false'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - name: Extract metadata
        if: steps.check_secrets.outputs.skip == 'false'
        id: meta
        run: |
          # Determine image tag
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            TAG="${{ github.ref_name }}"
          else
            TAG="latest"
          fi
          
          # Set outputs
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "variant=${{ matrix.variant }}" >> $GITHUB_OUTPUT
          
          # Construct image name
          IMAGE_NAME="${{ secrets.DOCKERHUB_USERNAME }}/telechat"
          echo "image_name=${IMAGE_NAME}" >> $GITHUB_OUTPUT
      
      - name: Determine Dockerfile
        if: steps.check_secrets.outputs.skip == 'false'
        id: dockerfile
        run: |
          if [[ "${{ matrix.variant }}" == "gpu" ]]; then
            echo "dockerfile=Dockerfile.full-gpu" >> $GITHUB_OUTPUT
          else
            echo "dockerfile=Dockerfile.full-cpu" >> $GITHUB_OUTPUT
          fi
      
      - name: Build and push Docker image
        if: steps.check_secrets.outputs.skip == 'false'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ steps.dockerfile.outputs.dockerfile }}
          push: true
          tags: |
            ${{ steps.meta.outputs.image_name }}:${{ steps.meta.outputs.tag }}-${{ matrix.variant }}
            ${{ steps.meta.outputs.image_name }}:latest-${{ matrix.variant }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Job 2: Build and push to GitHub Container Registry (GHCR)
  build-and-push-ghcr:
    name: Build and Push to GHCR
    runs-on: ubuntu-latest
    
    # IMPORTANT: Ensure the GITHUB_TOKEN has write:packages permission
    # This is typically enabled by default for workflows, but if you encounter
    # permission errors, you may need to:
    # 1. Go to Settings > Actions > General
    # 2. Under "Workflow permissions", select "Read and write permissions"
    # OR
    # 3. Create a Personal Access Token (PAT) with write:packages scope
    #    and add it as a secret named GH_PAT, then use ${{ secrets.GH_PAT }}
    permissions:
      contents: read
      packages: write
    
    strategy:
      matrix:
        variant: [cpu]  # Add 'gpu' if you want to build GPU images in CI
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY_GHCR }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract metadata
        id: meta
        run: |
          # Normalize repository name for GHCR (must be lowercase)
          REPO_NAME=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          
          # Determine image tag
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            TAG="${{ github.ref_name }}"
            COMMIT_SHA="${{ github.sha }}"
          else
            TAG="latest"
            COMMIT_SHA="${{ github.sha }}"
          fi
          
          # Set outputs
          echo "repo_name=${REPO_NAME}" >> $GITHUB_OUTPUT
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "commit_sha=${COMMIT_SHA}" >> $GITHUB_OUTPUT
          echo "variant=${{ matrix.variant }}" >> $GITHUB_OUTPUT
      
      - name: Determine Dockerfile
        id: dockerfile
        run: |
          if [[ "${{ matrix.variant }}" == "gpu" ]]; then
            echo "dockerfile=Dockerfile.full-gpu" >> $GITHUB_OUTPUT
          else
            echo "dockerfile=Dockerfile.full-cpu" >> $GITHUB_OUTPUT
          fi
      
      - name: Build and push Docker image to GHCR
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ steps.dockerfile.outputs.dockerfile }}
          push: true
          tags: |
            ${{ env.REGISTRY_GHCR }}/${{ steps.meta.outputs.repo_name }}:${{ steps.meta.outputs.tag }}-${{ matrix.variant }}
            ${{ env.REGISTRY_GHCR }}/${{ steps.meta.outputs.repo_name }}:sha-${{ steps.meta.outputs.commit_sha }}-${{ matrix.variant }}
            ${{ env.REGISTRY_GHCR }}/${{ steps.meta.outputs.repo_name }}:latest-${{ matrix.variant }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Output image information
        run: |
          echo "✅ Image published to GHCR:"
          echo "  - ${{ env.REGISTRY_GHCR }}/${{ steps.meta.outputs.repo_name }}:${{ steps.meta.outputs.tag }}-${{ steps.meta.outputs.variant }}"
          echo "  - ${{ env.REGISTRY_GHCR }}/${{ steps.meta.outputs.repo_name }}:sha-${{ steps.meta.outputs.commit_sha }}-${{ steps.meta.outputs.variant }}"
          echo "  - ${{ env.REGISTRY_GHCR }}/${{ steps.meta.outputs.repo_name }}:latest-${{ steps.meta.outputs.variant }}"
